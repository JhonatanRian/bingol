class CardGenerator{ctx=null;canvas=null;dataSources={titleId:'title',resultsCanvasId:'generator-results-canvas',templatesPopupId:'templates-popup',templatesPopupBackgroundId:'templates-popup-background',};options={canvasWidth:735,canvasHeight:801,paddingLeft:72,paddingRight:77,paddingTop:154,paddingBottom:65,cellTextPadding:15,cellTextTopPadding:6,titleTopPadding:58,paddingTopGrid:100,paddingLeftGrid:70,imagesFolder:'/wp-content/themes/betheme-child/bingo_generator/images/',gridImageName:'grid%d.png',logoImageName:'bingo-logo.png',};title='BINGO BLITZ';gridSizeImages=[];gridSize=5;bgImage=null;gridImage=null;logoImage=null;currentTemplate=null;words=[];withTitle=!1;withWhiteBg=!1;setTitle(title){this.title=title};setGridSize(gridSize){this.gridSize=gridSize};getGridSize(){return this.gridSize};calculateFontSize(text,maxWidth,fontSize){this.ctx.font=fontSize+"px "+this.currentTemplate.fontFamily;while(this.ctx.measureText(text).width>maxWidth){fontSize--;if(fontSize<0){break}
this.ctx.font=fontSize+"px "+this.currentTemplate.fontFamily}
return fontSize};drawTitleBackground(width){const minWidth=350;const paddingWidth=30;let ctx=this.ctx;width+=paddingWidth*2;if(width<minWidth){width=minWidth}
let x=this.options.canvasWidth/2-width/2;let y=this.options.titleTopPadding-33;ctx.fillStyle='#fff';defineRoundedRect(x,y,width,60,30);ctx.fill();defineRoundedRect(x-1000,y,width,60,30);ctx.shadowColor='black';ctx.shadowBlur=10;ctx.shadowOffsetX=1000;ctx.strokeStyle='white';ctx.lineWidth=4;ctx.globalCompositeOperation='destination-out';ctx.stroke();ctx.globalCompositeOperation='source-over';function defineRoundedRect(x,y,w,h,r){ctx.beginPath();ctx.moveTo(x+r,y);ctx.arcTo(x+w,y,x+w,y+h,r);ctx.arcTo(x+w,y+h,x,y+h,r);ctx.arcTo(x,y+h,x,y,r);ctx.arcTo(x,y,x+w,y,r);ctx.closePath()}};drawTitle(){let maxTextWidth=this.options.canvasWidth-this.options.paddingLeft-this.options.paddingRight;let titleFontSize=this.calculateFontSize(this.title,maxTextWidth,this.currentTemplate.titleFontSize);this.drawTitleBackground(this.ctx.measureText(this.title).width);let ctx=this.ctx
ctx.font=titleFontSize+"px "+this.currentTemplate.titleFontFamily;ctx.fillStyle=this.currentTemplate.titleColor;ctx.textBaseline='middle';ctx.textAlign='center';ctx.lineWidth=6;this.ctx.fillText(this.title,this.options.canvasWidth/2,this.options.titleTopPadding,maxTextWidth);ctx.shadowOffsetX=0;ctx.shadowOffsetY=0;ctx.shadowBlur=0};drawGrid(){const rowsAmount=this.gridSize;const colsAmount=this.gridSize;let tableTop=this.options.paddingTop;let tableLeft=this.options.paddingLeft;let tableRight=this.options.canvasWidth-this.options.paddingRight;let tableBottom=this.options.canvasHeight-this.options.paddingBottom;let cellHeight=((tableBottom-tableTop)/rowsAmount);let cellWidth=((tableRight-tableLeft)/colsAmount);let ctx=this.ctx;ctx.beginPath();ctx.fillStyle=this.currentTemplate.color;ctx.strokeStyle=this.currentTemplate.color;ctx.textBaseline='middle';ctx.textAlign='center';ctx.lineWidth=4;for(let i=0;i<rowsAmount;i++){for(let j=0;j<colsAmount;j++){if(this.getLogoPosition()[0]===i&&this.getLogoPosition()[1]===j){let logoWidth=cellWidth-this.options.cellTextPadding;let logoHeight=logoWidth*this.logoImage.naturalHeight/this.logoImage.naturalWidth;this.ctx.drawImage(this.logoImage,(tableLeft+cellWidth*i+cellWidth/2)-logoWidth/2+2,(tableTop+cellHeight*j+cellHeight/2)-logoHeight/2,logoWidth,logoHeight)}else{let text=this.words[i][j];let maxTextWidth=cellWidth-2*this.options.cellTextPadding;let fontSize=this.calculateFontSize(text,maxTextWidth,this.currentTemplate.fontSize);ctx.font=fontSize+"px "+this.currentTemplate.fontFamily;ctx.fillText(text,tableLeft+cellWidth*i+cellWidth/2,tableTop+cellHeight*j+cellHeight/2+this.options.cellTextTopPadding)}}}};filterWord(word){return word.replaceAll(/[^a-zA-Z0-9\+\-\!\?\.\_\$\#\@\%\&\*, ]/gi,'')};createWordsList(){const rangeMin=1;const rangeMax=75;const gridSizeMin=3;const gridSizeMax=5;let gridSize=this.gridSize;if(gridSize<gridSizeMin){gridSize=gridSizeMin}
if(gridSize>gridSizeMax){gridSize=gridSizeMax}
let bingoWords=[];let countColumnElements=Math.ceil((rangeMax-rangeMin+1)/gridSize);for(let i=0;i<gridSize;i++){let columnWords=[];for(let j=countColumnElements*i+1;j<=countColumnElements*(i+1);j++){if(j<=rangeMax){columnWords.push(j)}}
bingoWords[i]=columnWords}
return bingoWords};setCurrentTemplate(templates,optionValue){let template;templates.forEach((elem)=>{elem.values.forEach((subelem)=>{if(subelem.optionValue===optionValue){template=subelem}})});if(template===undefined){template=templates[0]}
this.currentTemplate=template};shuffleArray(array){let currentIndex=array.length,temporaryValue,randomIndex;while(0!==currentIndex){randomIndex=Math.floor(Math.random()*currentIndex);currentIndex-=1;temporaryValue=array[currentIndex];array[currentIndex]=array[randomIndex];array[randomIndex]=temporaryValue}
return array}
shuffleWords(){let words=this.words;for(let i=0;i<words.length;i++){words[i]=this.shuffleArray(words[i])}
this.words=words};getWords(){return this.words};setWords(words){this.words=words};drawBingoCard(){if(this.isReadyForDraw()===!1){return}
if(this.withWhiteBg){this.ctx.fillStyle="white";this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)}
this.ctx.drawImage(this.bgImage,0,0);this.ctx.drawImage(this.gridImage,this.options.paddingLeftGrid,this.options.paddingTopGrid);this.drawGrid();if(this.withTitle){this.drawTitle()}};getLogoPosition(){if(this.gridSize===5){return[2,2]}
if(this.gridSize===4){return[3,3]}
if(this.gridSize===3){return[1,1]}};createGridInputs(){const x=this.gridSize;const y=this.gridSize;jQuery('.grid-inputs div').remove();let gridInputs=jQuery('.grid-inputs');gridInputs[0].className=gridInputs[0].className.replace(/grid-size-\d/,'');for(let i=0;i<x;i++){for(let j=0;j<y;j++){let gridDiv=jQuery('<div></div>');if(this.getLogoPosition()[0]===i&&this.getLogoPosition()[1]===j){gridInputs.append(gridDiv);continue}
if(j<=(this.gridSize/2-1)){gridDiv.addClass('left')}else{gridDiv.addClass('right')}
let gridInput=jQuery('<input type="text" maxlength="15" data-x-pos="'+i+'" data-y-pos="'+j+'" value="" name="'+i+'-'+j+'" />');gridInput.on('focus',function(event){this.storeGridInputCurrentValue(event)}.bind(this));gridInput.on('blur',function(event){let filteredWord=this.replaceWordByInput(event);dispatchEvent(new CustomEvent('gridInputWasChanged',{detail:{word:filteredWord}}))}.bind(this));gridDiv.append(gridInput);gridInputs.append(gridDiv)}}
gridInputs.addClass('grid-size-'+x)};isReadyForDraw(){return this.bgImage.naturalHeight>0&&this.gridImage.naturalHeight>0&&this.logoImage.naturalHeight>0};storeGridInputCurrentValue(event){let eventTarget=event.target;let x=eventTarget.dataset.xPos;let y=eventTarget.dataset.yPos;eventTarget.dataset.value=this.words[y][x];eventTarget.value=this.words[y][x]};replaceWordByInput(event){let eventTarget=event.target;let replaceWith=eventTarget.value;let x=jQuery(eventTarget).data('x-pos');let y=jQuery(eventTarget).data('y-pos');let filteredWord=this.filterWord(replaceWith);if(filteredWord.trim()===eventTarget.dataset.value){eventTarget.value='';return}
if(filteredWord.trim()===''){eventTarget.value='';return}
this.words[y][x]=filteredWord;eventTarget.value='';this.generateBingoCard();return filteredWord};isDuplicatedWord(word){for(let i=0,wordsXLength=this.words.length;i<wordsXLength;i++){for(let j=0,wordsYLength=this.words[i].length;j<wordsYLength;j++){if(this.words[i][j].toString()===word){return!0}}}
return!1};generateBingoCard(randomize=!1,withTitle=!1,withWhiteBg=!1){this.withTitle=withTitle;this.withWhiteBg=withWhiteBg;if(this.words.length===0){this.words=this.createWordsList();this.shuffleWords()}else if(randomize){this.shuffleWords()}
this.canvas=document.getElementById(this.dataSources.resultsCanvasId);this.ctx=this.canvas.getContext('2d');this.ctx.canvas.width=this.options.canvasWidth;this.ctx.canvas.height=this.options.canvasHeight;if(this.gridSizeImages[this.gridSize]===undefined){this.gridImage=new Image()}else{this.gridImage=this.gridSizeImages[this.gridSize]}
if(this.gridImage.naturalHeight===0){this.gridImage.onload=()=>{this.gridSizeImages[this.gridSize]=this.gridImage;this.drawBingoCard()};this.gridImage.src=this.options.imagesFolder+this.options.gridImageName.replace('%d',this.gridSize)}else{this.drawBingoCard()}
if(!this.bgImage||this.bgImage.src.split('/').pop()!==this.currentTemplate.imgUrl.split('/').pop()){this.bgImage=new Image()}
if(this.logoImage===null){this.logoImage=new Image()}
if(this.bgImage.naturalHeight===0){this.bgImage.onload=()=>{this.drawBingoCard()};this.bgImage.src=this.options.imagesFolder+this.currentTemplate.imgUrl}else{this.drawBingoCard()}
if(this.logoImage.naturalHeight===0){this.logoImage.onload=()=>{this.drawBingoCard()};this.logoImage.src=this.options.imagesFolder+this.options.logoImageName}else{this.drawBingoCard()}};createTemplatesPopup(templates){for(let i=0,templatesLength=templates.length;i<templatesLength;i++){let tab=jQuery('<li>'+templates[i].groupName+'</li>');if(0===i){tab.addClass('active')}
tab.appendTo('#'+this.dataSources.templatesPopupId+' .tabs');tab.click(function(){if(jQuery(this).hasClass('active')){return}
let tabLi=jQuery('.tabs li');tabLi.removeClass('active');jQuery(this).addClass('active');let countTabs=tabLi.length;let keyActive=countTabs-1;for(let i=0;i<countTabs;i++){if(tabLi.eq(i).hasClass('active')){keyActive=i;break}}
let tabContentLi=jQuery('.tabs-content li');tabContentLi.removeClass('active');tabContentLi.eq(keyActive).addClass('active')});let tabContent=jQuery('<li></li>');for(let j=0,tabContentLength=templates[i].values.length;j<tabContentLength;j++){let wrapper=jQuery('<div></div>');let title=jQuery('<span>'+templates[i].values[j].title+'</span>');let image=jQuery('<img src="'+this.options.imagesFolder+templates[i].values[j].imgUrl+'" alt="'+templates[i].values[j].title+'" />');let button=jQuery('<button></button>');button.val(templates[i].values[j].optionValue);if(i===0&&j===0){button.addClass('active');this.setCurrentTemplate(templates,templates[i].values[j].optionValue)}
button.click(function(event){this.setCurrentTemplate(templates,jQuery(event.target).val());jQuery('#'+this.dataSources.templatesPopupId+' button').removeClass('active');jQuery(event.target).addClass('active');this.generateBingoCard();jQuery('.close-button').click()}.bind(this))
title.appendTo(wrapper);image.appendTo(wrapper);button.appendTo(wrapper);wrapper.appendTo(tabContent)}
if(0===i){tabContent.addClass('active')}
tabContent.appendTo('#'+this.dataSources.templatesPopupId+' .tabs-content')}
jQuery('#showTemplatesPopup').click(function(){jQuery('<div id="'+this.dataSources.templatesPopupBackgroundId+'"></div>').appendTo('body');jQuery('#'+this.dataSources.templatesPopupId).removeClass('hidden')}.bind(this));jQuery('#'+this.dataSources.templatesPopupId+' .close-button').click(function(){jQuery('#'+this.dataSources.templatesPopupBackgroundId).remove();jQuery('#'+this.dataSources.templatesPopupId).addClass('hidden')}.bind(this))};createGridSizeSelect(){jQuery('.grid-size-options li').click(function(event){jQuery('.grid-size-options li').removeClass('active');jQuery(event.target).addClass('active');this.setGridSize(parseInt(jQuery(event.target).text().split('X').pop()));this.createGridInputs();this.setWords(this.createWordsList());this.shuffleWords();this.generateBingoCard();jQuery('.grid-size .value').text(jQuery(event.target).text());dispatchEvent(new CustomEvent('gridSizeWasChanged'))}.bind(this))};createTitleInput(){let titleInput=jQuery('#'+this.dataSources.titleId);titleInput.val(this.title);titleInput.on('blur',(event)=>{event.target.value=this.filterWord(event.target.value)
this.setTitle(event.target.value)})};constructor(dataSources=null){this.dataSources=dataSources||this.dataSources}}